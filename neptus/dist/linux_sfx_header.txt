#!/bin/bash

if [ -z "$BASH_VERSION" ]; then
    /bin/bash $0
    exit $?
fi

# Usage: cat linux-sfx-header package.tgz > sfxpackage.sh

more <<"EOF"
--------------------------------------------------
         Neptus @EXTRA_DIST_NAME@                 
--------------------------------------------------

(c) @YEAR@
Underwater Systems and Technology Laboratory, LSTS-FEUP
Universidade do Porto
and Developers. All rights reserved.

     Version @NUMERIC_VERSION@ released on @DATE@ 

--------------------------------------------------

@LICENSE@

EOF

agreed=
while [ x$agreed = x ]; do
    echo
    echo "Do you agree to the above license terms? [yes or no] "
    read reply leftover
    case $reply in
	y* | Y*)
	    agreed=1;;
	n* | n*)
    echo "If you don't agree to the license you can't install this software";
    exit 1;;
    esac
done

echo ""
echo "--------------------------------------------------"
echo "         Neptus @EXTRA_DIST_NAME@                 "
echo "--------------------------------------------------"
echo ""
echo "(c) @YEAR@"
echo "Underwater Systems and Technology Laboratory, LSTS-FEUP"
echo "Universidade do Porto"
echo "and Developers. All rights reserved."
echo ""
echo "     Version @NUMERIC_VERSION@ released on @DATE@ "
echo ""
echo "Unpacking..."
SKIP=`awk '/^__ARCHIVE__/ { print NR + 1; exit 0; }' $0`
tail -n +$SKIP $0 | tar xz
echo ""

MACHINE_TYPE=`uname -m`
if [ ${MACHINE_TYPE} = 'x86_64' ]; then
    rm -Rf "@INSTALL_DIR@/jre" && mv "@INSTALL_DIR@/jre64" "@INSTALL_DIR@/jre" &> /dev/null
else
    rm -Rf "@INSTALL_DIR@/jre64" &> /dev/null
fi

# Creating Launchers
createLauncher()
{
  # To be called in the installed folder 
  # 1 - Launcher name
  # 2 - Arguments for launcher

  fullPath=$(pwd);
  
  echo "[Desktop Entry]" > "$1.desktop"
  echo "Version=1.0" >> "$1.desktop"
  echo "Type=Application" >> "$1.desktop"
  echo "Terminal=false" >> "$1.desktop"
  echo "Icon[en]=$fullPath/neptus.png" >> "$1.desktop"
  echo "Name[en]=$1" >> "$1.desktop"
  echo "Exec=\"$fullPath/neptus\" $2" >> "$1.desktop"
  echo "Name=$1" >> "$1.desktop"
  echo "Icon=$fullPath/neptus.png" >> "$1.desktop"

  chmod a+x "$1.desktop"
}

# Check for Unity
checkForUnity()
{
  if [[ $(echo $XDG_CURRENT_DESKTOP) == *"Unity"* ]]; 
  then
      echo "Using Ubuntu's Unity!";
      
      echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>" > "conf/general-properties.xml"
      echo "<!DOCTYPE properties SYSTEM \"http://java.sun.com/dtd/properties.dtd\">" >> "conf/general-properties.xml"
      echo "<properties>" >> "conf/general-properties.xml"
      echo "<comment>Properties generated by Neptus</comment>" >> "conf/general-properties.xml"
      echo "<entry key=\"Place Main Vehicle Combobox On Menu Or Status Bar\">false</entry>" >> "conf/general-properties.xml"
      echo "</properties>" >> "conf/general-properties.xml"
  fi
}

cd "@INSTALL_DIR@"
# Neptus launcher
createLauncher Neptus
# Neptus MRA launcher
createLauncher "Neptus MRA" mra
# checkForUnity
cd -

echo "Done. Type './neptus' in the @INSTALL_DIR@ directory to launch Neptus"
echo ""
exit 0

__ARCHIVE__
